<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no,width=device-width">

<!-- ─── core Leaflet assets ─────────────────────────────────────── -->
<link rel="stylesheet" href="css/leaflet.css">
<script src="js/leaflet.js"></script>

<!-- ─── MapTiler SDK for vector tiles + Leaflet bridge ──────────── -->
<link  href="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.css" rel="stylesheet">
<script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.2.0/maptiler-sdk.umd.min.js"></script>
<script src="https://cdn.maptiler.com/leaflet-maptilersdk/v4.0.2/leaflet-maptilersdk.umd.min.js"></script>

<!-- ─── extra libs from qgis2web we still use ───────────────────── -->
<link rel="stylesheet" href="css/qgis2web.css">
<link rel="stylesheet" href="css/fontawesome-all.min.css">
<script src="js/qgis2web_expressions.js"></script>
<script src="js/leaflet-hash.js"></script>
<script src="js/Autolinker.min.js"></script>

<style>
html,body,#map{width:100%;height:100%;margin:0}
#map{background:#e6ccff;}          /* seen while tiles load */

/* ── Popup card theme ─────────────────────────────────────────── */
.leaflet-popup-content-wrapper{
  background:#f6ead4;border-radius:12px;padding:0;
}
.leaflet-popup-tip{display:none}

.popup-inner{
  font-size:14px;line-height:1.4;padding:12px;max-width:560px
}
.popup-title {font-size:22px;font-weight:700;text-align:center;margin:0 0 6px}

.popup-img img{
  width:100%;border-radius:6px;margin-bottom:8px;display:block
}

.popup-place {
  font-style:italic;
  text-align:right;
  margin-top:6px;
  margin-bottom:0
}

.leaflet-popup-close-button{display:none !important} /* no close button, use ESC key */
[id^="cusdis_thread_"]{height:150px;overflow-y:auto;margin-top:6px}
</style>

<title>World Map + Letter Island</title>
<script defer src="https://cusdis.com/js/cusdis.es.js"></script>

</head>
<body>
<div id="map"></div>

<!-- ─── data exported by qgis2web ───────────────────────────────── -->
<script src="data/letter_island_1.js"></script>
<script src="data/WorldMapSheet1_2.js"></script>

<script>
/* ============ CONFIGURE YOUR MAPTILER INFO HERE ================== */
const MT_KEY   = 'J6aDtSRgul4B0mvpAhyQ';          //  ← your whitelisted key
const STYLE_ID = '01970420-d684-7667-a459-65bfada4ce28';  //  ← your style ID
/* ================================================================= */

/* 1 ── create map & basemap ─────────────────────────────────────── */
const map = L.map('map', { zoomControl:false })
             .fitBounds([[-32.55,-174.5],[155.0,206.9]]);
L.control.zoom({position:'topleft'}).addTo(map);
new L.Hash(map);     // shareable URL hash

L.maptiler
  .maptilerLayer({
      apiKey : MT_KEY,
      style  : `https://api.maptiler.com/maps/${STYLE_ID}/style.json?key=${MT_KEY}`
  })
  .addTo(map);

/* 2 ── polygon layer: Letter Island ─────────────────────────────── */
function styleIsland(){
  return {
    color:'#af6cc6',
    weight:1,
    fillColor:'#e8caff',
    fillOpacity:1,
    interactive:false
  };
}
L.geoJson(json_letter_island_1,{
  style:styleIsland,
  onEachFeature:(f,l)=>{
      const id = f.properties.Island || f.properties.id || 'Island';
      l.bindPopup(`<div class="popup-inner">
                     <div class="popup-title">${id}</div>
                   </div>`);
  }
}).addTo(map);

/* 3 ── point layer: memories & images ───────────────────────────── */
const pinIcon = L.icon({
  iconUrl    :'markers/WorldMapSheet1_2.svg',
  iconSize   :[40,40],
  iconAnchor :[14.82,29.64],
  popupAnchor:[180,200]
});

const autolink = new Autolinker({truncate:{length:30,location:'smart'}});
const cusdisId = '9c22f7ce-f8ce-41ba-80b9-7443ae182490';

function popupHTML(f){
  const p  = f.properties;
  const id = (p.Title || p.location || Date.now()).toString().replace(/\s+/g,'_');
  const imgPath = p.ImageURL && p.ImageURL!=='y'
                ? `<div class="popup-img"><img src="${autolink.link(p.ImageURL)}"></div>` : '';

  return `<div class="popup-inner">
            ${p.Title ? `<div class="popup-title">${autolink.link(p.Title)}</div>` : ''}
            ${imgPath}
            ${p.location ? `<div class="popup-place">${autolink.link(p.location)}</div>` : ''}
            <div id="cusdis_thread"
                 data-host="https://cusdis.com"
                 data-app-id="${cusdisId}"
                 data-page-id="${id}"
                 data-page-url="${location.href}#${id}"
                 data-page-title="${p.Title||'World Map'}">
            </div>
          </div>`;
}


L.geoJson(json_WorldMapSheet1_2,{
  pointToLayer:(f,ll)=>L.marker(ll,{icon:pinIcon}),
  onEachFeature:(f,l)=>{
      l.bindPopup(popupHTML(f),{maxHeight:800});
      l.on('popupopen', () => {
        const el = l.getPopup().getElement().querySelector('#cusdis_thread');
        if (window.CUSDIS && el) {
          const p   = f.properties;
          const pid = (p.Title || p.location || Date.now()).toString().replace(/\s+/g,'_');

          window.CUSDIS.renderThread({
            host     : 'https://cusdis.com',
            appId    : cusdisId,
            element  : el,           // explicit mount point
            pageId   : pid,
            pageTitle: p.Title || 'World Map',
            pageUrl  : location.href + '#' + pid
          });
        }
      });
  }
}).addTo(map);


</script>
</body>
</html>
